<?php
session_start();
include 'rcon.html';

// --- CONFIG RCON ---
$rcon_host = 'neo-2.arqonara.com'; 
$rcon_port =  25218;
$rcon_pass = 'web';

$error = "";
$status_msg = "";

// 1. DETEKSI VPN/PROXY SEDERHANA
$proxy_headers = array('HTTP_VIA', 'HTTP_X_FORWARDED_FOR', 'HTTP_FORWARDED_FOR', 'HTTP_X_FORWARDED', 'HTTP_FORWARDED', 'HTTP_CLIENT_IP', 'HTTP_FORWARDED_FOR_IP', 'VIA', 'X_FORWARDED_FOR', 'FORWARDED_FOR', 'X_FORWARDED', 'FORWARDED', 'CLIENT_IP', 'FORWARDED_FOR_IP', 'HTTP_PROXY_CONNECTION');
foreach($proxy_headers as $x){
    if (isset($_SERVER[$x])) {
        die("<h1 style='font-family:sans-serif; text-align:center; margin-top:100px;'>VPN/PROXY TERDETEKSI! Matikan VPN untuk mengakses sistem ini.</h1>");
    }
}

// 2. LOGIC LOGIN & LOCK SESSION (ANTI-GANTI AKUN)
if (isset($_POST['login'])) {
    $input_user = htmlspecialchars($_POST['mc_user']);
    
    // Cek apakah browser ini sudah pernah login dengan username lain sebelumnya
    if (isset($_SESSION['locked_user']) && $_SESSION['locked_user'] !== $input_user) {
        $error = "Kamu mau akun lain untuk dapet uang lagi? Sesi ini terkunci untuk user: " . $_SESSION['locked_user'];
    } else {
        $_SESSION['username'] = $input_user;
        $_SESSION['locked_user'] = $input_user; // Kunci permanen di sesi ini
        if(!isset($_SESSION['has_claimed'])) $_SESSION['has_claimed'] = false;
    }
}

// 3. LOGOUT & RESET USERNAME (Hanya jika belum klaim)
if (isset($_GET['logout'])) {
    if (isset($_SESSION['has_claimed']) && $_SESSION['has_claimed'] == true) {
        // Jika sudah klaim, jangan hapus locked_user (Biar gak bisa ganti akun di browser sama)
        unset($_SESSION['username']);
    } else {
        // Jika belum klaim (salah ketik nama), boleh reset total
        session_destroy();
    }
    header("Location: index.php");
    exit();
}

// 4. KLAIM REWARD (RANDOM 5K - 10K)
if (isset($_POST['claim_reward']) && $_SESSION['has_claimed'] == false) {
    $user = $_SESSION['username'];
    $amount = rand(5000, 10000);
    
    $rcon = new MinecraftRcon($rcon_host, $rcon_port, $rcon_pass);
    if ($rcon->send("eco give $user $amount")) {
        $_SESSION['has_claimed'] = true;
        $status_msg = "SUCCESS: Rp" . number_format($amount) . " terkirim ke $user!";
    } else {
        $error = "Koneksi RCON Gagal! Cek Server.";
    }
}
?>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monz Ultra-Vault | Secure Reward System</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg: #f0f4f9;
            --primary: #2563eb;
            --accent: #3b82f6;
            --white: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --danger: #ef4444;
            --success: #22c55e;
            --glass: rgba(255, 255, 255, 0.8);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Plus Jakarta Sans', sans-serif; }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at 2px 2px, #e2e8f0 1px, transparent 0);
            background-size: 40px 40px;
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .card {
            background: var(--white);
            width: 100%;
            max-width: 460px;
            padding: 50px 40px;
            border-radius: 40px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(0,0,0,0.02);
            text-align: center;
            position: relative;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .logo-area { font-size: 3.5rem; color: var(--primary); margin-bottom: 30px; filter: drop-shadow(0 10px 15px rgba(37, 99, 235, 0.2)); }

        h2 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.5px; margin-bottom: 12px; }
        p { color: var(--text-muted); font-size: 0.95rem; line-height: 1.6; margin-bottom: 30px; }

        input {
            width: 100%;
            padding: 18px 25px;
            border-radius: 20px;
            border: 2px solid #eef2f6;
            background: #f8fafc;
            font-size: 1rem;
            font-weight: 600;
            outline: none;
            transition: 0.3s;
            margin-bottom: 20px;
        }
        input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 5px rgba(37, 99, 235, 0.05); }

        .btn {
            background: var(--primary);
            color: white;
            padding: 18px;
            width: 100%;
            border: none;
            border-radius: 20px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn:hover { background: var(--accent); transform: translateY(-3px); box-shadow: 0 15px 30px rgba(37, 99, 235, 0.2); }

        .btn-outline {
            background: transparent;
            color: var(--danger);
            border: 2px solid #fee2e2;
            margin-top: 15px;
            padding: 12px;
            font-size: 0.85rem;
        }
        .btn-outline:hover { background: #fef2f2; border-color: var(--danger); }

        /* Quiz Styles */
        .option {
            background: #f8fafc;
            padding: 18px;
            border-radius: 18px;
            border: 2px solid #f1f5f9;
            margin-bottom: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            text-align: left;
        }
        .option:hover { border-color: var(--primary); background: #fff; transform: scale(1.02); }

        .error-msg { background: #fff1f2; color: var(--danger); padding: 15px; border-radius: 15px; font-weight: 600; font-size: 0.85rem; margin-bottom: 20px; border-left: 4px solid var(--danger); }
        .success-msg { background: #f0fdf4; color: var(--success); padding: 20px; border-radius: 20px; font-weight: 700; margin-top: 20px; border: 1px solid #dcfce7; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <?php if ($error): ?> <div class="error-msg"><?= $error ?></div> <?php endif; ?>

    <?php if (!isset($_SESSION['username'])): ?>
        <div class="logo-area"><i class="fas fa-shield-halved"></i></div>
        <h2>Vault Access</h2>
        <p>Hubungkan akun Minecraft kamu untuk memulai validasi keamanan & klaim hadiah.</p>
        <form method="POST">
            <input type="text" name="mc_user" placeholder="Nama Minecraft..." required>
            <button type="submit" name="login" class="btn">Autentikasi Sekarang</button>
        </form>

    <?php elseif (isset($_SESSION['username']) && !$_SESSION['has_claimed']): ?>
        <div id="select-screen">
            <div class="logo-area" style="color: var(--success);"><i class="fas fa-user-check"></i></div>
            <h2>Pilih Ujian, <?= $_SESSION['username'] ?></h2>
            <p>Selesaikan salah satu ujian di bawah ini untuk membuka brankas hadiah.</p>
            <button class="btn" style="margin-bottom: 12px;" onclick="startQuiz('mtk')"><i class="fas fa-square-root-variable"></i> Matematika Sulit</button>
            <button class="btn" style="background: #0ea5e9;" onclick="startQuiz('mc')"><i class="fas fa-cube"></i> Pengetahuan Server</button>
            
            <a href="?logout=1" style="text-decoration: none;">
                <button class="btn btn-outline">Reset Username (Salah Ketik?)</button>
            </a>
        </div>

        <div id="quiz-screen" class="hidden">
            <h3 id="q-text" style="margin-bottom: 30px; font-size: 1.2rem; font-weight: 700;"></h3>
            <div id="options-box"></div>
        </div>

    <?php else: ?>
        <div class="logo-area" style="color: #fbbf24;"><i class="fas fa-lock-open"></i></div>
        <h2>Brankas Terbuka!</h2>
        <div class="success-msg"><?= $status_msg ? $status_msg : "Akses Terkunci: Kamu sudah mengklaim hadiah di sesi ini." ?></div>
        <p style="margin-top: 30px; font-size: 0.8rem;">Sesi browser ini dikunci untuk keamanan. Gunakan perangkat lain jika ingin mencoba akun berbeda.</p>
        <a href="?logout=1" style="text-decoration: none;"><button class="btn btn-outline">Logout Sesi</button></a>
    <?php endif; ?>
</div>

<script>
    const quizData = {
        mtk: [
            { q: "Berapakah nilai dari âˆ« (2x + 3) dx dari 0 sampai 2?", o: ["8", "10", "12", "6"], a: 1 },
            { q: "Selesaikan: 25% dari 480 dibagi 3 + 15?", o: ["55", "45", "65", "50"], a: 0 }
        ],
        mc: [
            { q: "Protokol RCON Minecraft bekerja pada layer transport apa?", o: ["UDP", "TCP", "HTTP", "FTP"], a: 1 },
            { q: "Flag apa yang digunakan untuk mengatur port RCON di server.properties?", o: ["rcon.port", "server-rcon-port", "rcon.port-number", "rcon-port"], a: 0 }
        ]
    };

    let current = 0;
    let category = "";

    function startQuiz(type) {
        category = type;
        document.getElementById('select-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        renderQ();
    }

    function renderQ() {
        const q = quizData[category][current];
        document.getElementById('q-text').innerText = q.q;
        const box = document.getElementById('options-box');
        box.innerHTML = "";
        
        q.o.forEach((opt, i) => {
            const div = document.createElement('div');
            div.className = 'option';
            div.innerText = opt;
            div.onclick = () => {
                if(i === q.a) {
                    current++;
                    if(current < quizData[category].length) renderQ();
                    else finishQuiz();
                } else {
                    alert("Salah Jawaban! Kamu Gagal.");
                    location.href = "?logout=1";
                }
            };
            box.appendChild(div);
        });
    }

    function finishQuiz() {
        const form = document.createElement('form');
        form.method = 'POST';
        const input = document.createElement('input');
        input.type = 'hidden'; input.name = 'claim_reward';
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
</script>

</body>
</html>